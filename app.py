# https://huggingface.co/koajoel/PolyFormer
import os
import torch
import numpy as np
from fairseq import utils,tasks
from utils.checkpoint_utils import load_model_ensemble_and_task
from models.polyformer import PolyFormerModel
import cv2

import torch
import numpy as np
from fairseq import utils, tasks
from fairseq import checkpoint_utils
from utils.eval_utils import eval_step
from tasks.refcoco import RefcocoTask
from models.polyformer import PolyFormerModel
from PIL import Image
from torchvision import transforms
import cv2
import gradio as gr
import math
from io import BytesIO
import base64
import re
from demo import visual_grounding

title = "PolyFormer for Visual Grounding"

description = """<p style='text-align: center'> <a href='https://polyformer.github.io/' target='_blank'>Project Page</a> | <a href='https://arxiv.org/pdf/2302.07387.pdf' target='_blank'>Paper</a> | <a href='https://github.com/amazon-science/polygon-transformer' target='_blank'>Github Repo</a></p>
                 <p style='text-align: left'> Demo of PolyFormer for referring image segmentation and referring expression comprehension. Upload your own image or click any one of the examples, and write a description about a certain object. Then click \"Submit\" and wait for the results.</p>
"""

"""examples = [['demo/vases.jpg', 'the blue vase on the left'],
            ['demo/dog.jpg', 'the dog wearing glasses'],
            ['demo/bear.jpeg', 'a bear astronaut in the space'],
            ['demo/unicorn.jpeg', 'a unicorn doing computer vision research'],
            ['demo/pig.jpeg', 'a pig robot preparing a delicious meal'],
            ['demo/otta.png', 'a gentleman otter in a 19th century portrait'],
            ['demo/pikachu.jpeg', 'a pikachu fine-dining  with  a view  to  the  Eiffel Tower'],
            ['demo/cabin.jpeg', 'a small cabin on top of a snowy mountain in the style of Disney art station']
            ]"""
#18314_3	RL_20190321	inferior	127,90,145,107	97.72797275608079,126.59090375504758,98.72279673072737,128.26170965727275,99.71762070537395,129.9325155594979,100.71244468002051,131.60332146172303,101.70726865466709,133.27412736394817,102.70209262931367,134.94493326617334,103.69691660396025,136.61573916839848,104.69174057860681,138.28654507062362,105.68656455325339,139.95735097284876,106.68138852789997,141.6281568750739,97.72797275608079,126.59090375504758,96.93002848603369,128.38018171388356,96.1320842159866,130.1694596727195,95.33413994593948,131.9587376315555,94.53619567589239,133.74801559039147,93.73825140584529,135.53729354922743,92.9403071357982,137.32657150806338,92.1423628657511,139.11584946689936,91.34441859570398,140.90512742573534,90.54647432565689,142.6944053845713,106.68138852789997,141.6281568750739,106.33244126290083,141.91341632986442,105.98311398625374,142.19177401784108,105.62830958776176,142.4529921239242,105.27207737974823,142.70593374874443,104.91039967937394,142.9383423851803,104.54457939330022,143.1590156070888,104.17304915776475,143.36737691066227,103.7983554123901,143.56567244147882,103.41782571692019,143.75551052168012,103.03180455729597,143.92262687659823,102.6354902329389,144.069973990554,102.23659985102714,144.2185564128682,101.8334602387622,144.36099392184988,101.42289059581236,144.4850792819634,101.00056340433656,144.57874321807176,100.5761109452229,144.66699412893504,100.15083687095903,144.75584956584498,99.7227624265477,144.81984715783037,99.29358025640249,144.85542652234435,98.86367630166933,144.87245873585343,98.4371208419092,144.86406389400364,98.01454532612115,144.82723239324986,97.59247300215065,144.7928761124611,97.17650130367838,144.75729877091945,96.76260041124188,144.71397303678094,96.34521288479445,144.65737680606543,95.92822060682812,144.58171076998116,95.51271646153182,144.49577032886447,95.10003488808871,144.38938059210778,94.69051188994199,144.28136225324124,94.28307351879775,144.18559248130768,93.87668600603938,144.1023000838235,93.47423125840723,144.01785956900568,93.08116149716079,143.91399680245667,92.6951499387622,143.78042558208108,92.31721482053399,143.63072692360728,91.95137419588863,143.47092651696875,91.59069071002304,143.29773136964067,91.22810001410545,143.12183709554375,90.8786726269871,142.92469157814048,90.54647432565689,142.6944053845713 	/home/shreya/scratch/Regional/MRI/RL_20190321/_0019_tf2d18_retro_iPAT_FB_SA6/IM-0019-0006.dcm	/home/shreya/scratch/Regional/regional_label/RL_20190321/_0019_tf2d18_retro_iPAT_FB_SA6/IM-0019-0006.npz	97.72797275608079,126.59090375504758,97.97155506080843,127.0,98.56697070622941,128.0,99.0,128.72727227962648,99.1623863516504,129.0,99.71762070537395,129.9325155594979,100.0,130.40677131142124,100.35321764249237,131.0,100.71244468002051,131.60332146172303,100.94863328791335,132.0,101.54404893333434,133.0,101.70726865466709,133.27412736394817,102.0,133.76576937501076,102.70209262931367,134.94493326617334,103.0,135.44526840680555,103.33029586959728,136.0,103.69691660396025,136.61573916839848,103.92571151501826,137.0,104.52112716043925,138.0,104.69174057860681,138.28654507062362,105.0,138.80426647039508,105.68656455325339,139.95735097284876,106.0,140.48376550218984,106.30737409670222,141.0,106.68138852789997,141.6281568750739,106.30737409670222,141.0,106.0,140.48376550218984,105.71195845128123,140.0,105.11654280586025,139.0,104.52112716043926,138.0,104.0,137.12476743860032,103.3302958695973,136.0,103.0,135.44526840680552,102.73488022417631,135.0,102.13946457875532,134.0,101.54404893333434,133.0,101.0,132.086270343216,100.35321764249237,131.0,100.0,130.40677131142124,99.75780199707138,130.0,99.16238635165041,129.0,99.0,128.72727227962645,98.56697070622943,128.0,98.0,127.04777324783169,97.72797275608079,126.59090375504758,97.54553268133134,127.0,97.09957387090358,128.0,96.93002848603369,128.38018171388356,96.65361506047583,129.0,96.20765625004806,130.0,96.0,130.46563997659084,95.7616974396203,131.0,95.33413994593948,131.9587376315555,95.0,132.70799953226552,94.86977981876478,133.0,94.53619567589239,133.74801559039147,94.0,134.9503590879402,93.73825140584529,135.53729354922743,93.5319033874815,136.0,93.08594457705374,137.0,92.9403071357982,137.32657150806338,92.63998576662598,138.0,92.19402695619823,139.0,92.0,139.43507819928956,91.74806814577046,140.0,91.34441859570398,140.90512742573534,91.0,141.67743775496422,90.85615052491494,142.0,90.54647432565689,142.6944053845713,91.0,142.66443490761517,92.0,142.59835159932285,93.0,142.5322682910305,94.0,142.46618498273816,95.0,142.4001016744458,96.0,142.33401836615346,97.0,142.2679350578611,98.0,142.20185174956876,99.0,142.1357684412764,100.0,142.06968513298406,101.0,142.0036018246917,102.0,141.93751851639936,103.0,141.87143520810702,104.0,141.80535189981467,105.0,141.73926859152232,106.0,141.67318528322997,106.68138852789997,141.6281568750739,106.33244126290083,141.91341632986442,106.0,142.17831857917432,105.62830958776176,142.4529921239242,105.27207737974823,142.70593374874443,105.0,142.8807665702507,104.54457939330022,143.1590156070888,104.17304915776475,143.36737691066227,103.7983554123901,143.56567244147882,103.41782571692019,143.75551052168012,103.03180455729597,143.92262687659823,102.6354902329389,144.069973990554,102.23659985102714,144.2185564128682,101.8334602387622,144.36099392184988,101.42289059581236,144.4850792819634,101.00056340433656,144.57874321807176,100.5761109452229,144.66699412893504,100.15083687095903,144.75584956584498,99.7227624265477,144.81984715783037,99.29358025640249,144.85542652234435,98.86367630166933,144.87245873585343,98.4371208419092,144.86406389400364,98.01454532612115,144.82723239324986,97.59247300215065,144.7928761124611,97.17650130367838,144.75729877091945,96.76260041124188,144.71397303678094,96.34521288479445,144.65737680606543,96.0,144.59473562065787,95.51271646153182,144.49577032886447,95.10003488808871,144.38938059210778,94.69051188994199,144.28136225324124,94.28307351879775,144.18559248130768,93.87668600603938,144.1023000838235,93.47423125840723,144.01785956900568,93.08116149716079,143.91399680245667,92.6951499387622,143.78042558208108,92.31721482053399,143.63072692360728,92.0,143.49216643059958,91.59069071002304,143.29773136964067,91.22810001410545,143.12183709554375,90.8786726269871,142.92469157814048,90.54647432565689,142.6944053845713 
#18279_4	RL_20190321	inferolateral	125,98,139,109	97.67714178381992,126.91924298485182,98.90842099109906,126.7214048940393,100.1397001983782,126.52356680322677,101.37097940565734,126.32572871241423,102.60225861293648,126.12789062160171,103.83353782021561,125.93005253078918,105.06481702749475,125.73221443997664,106.2960962347739,125.53437634916412,107.52737544205303,125.3365382583516,108.75865464933217,125.13870016753907,97.67714178381992,126.91924298485182,98.44382912442536,128.193926861306,99.2105164650308,129.46861073776023,99.97720380563625,130.74329461421442,100.7438911462417,132.01797849066864,101.51057848684715,133.29266236712286,102.2772658274526,134.56734624357708,103.04395316805804,135.8420301200313,103.81064050866348,137.1167139964855,104.57732784926893,138.3913978729397,108.75865464933217,125.13870016753907,108.8085338620469,125.47769429549575,108.84551302840002,125.82199415192008,108.87126332969405,126.17004274008795,108.89629619203507,126.51856879696251,108.90930908113718,126.87030941654928,108.90456481054426,127.22897540069653,108.88864687800408,127.59024218781849,108.87397677063942,127.95465372711419,108.86664258733391,128.32585600282997,108.85283881470562,128.70129706228153,108.83698145657777,129.0819283670932,108.81001031190158,129.46099474258722,108.78241440340877,129.84362657770515,108.74970296606422,130.2300699555874,108.70381869077683,130.6095414736867,108.64406807679683,130.98732022799553,108.57673870457569,131.3663580852002,108.50450385250151,131.7410888338089,108.42879217132926,132.1127446397394,108.3457614709437,132.48389610260725,108.2565003672242,132.8512379437685,108.16355937838554,133.2087828269601,108.07480521261692,133.56937610134483,107.98753400355577,133.9288623396307,107.88225994199513,134.27207744903865,107.74790712505579,134.6025192046631,107.5792593741417,134.91762980995932,107.38990110546351,135.2187014986947,107.19427770376205,135.51257506027818,106.99568762093783,135.80458198577168,106.7860897025466,136.09066399767994,106.55881864786149,136.36344695061445,106.31508597731592,136.62423328951002,106.07432534635068,136.8847489948571,105.83736831635237,137.1473897598684,105.59587978214026,137.40520807862282,105.35112358301879,137.66012565553189,105.09463570028544,137.9049431782961,104.83564118385316,138.14746403723956,104.57732784926893,138.3913978729397 	/home/shreya/scratch/Regional/2d_nifti_masks/RL20190321IM0019_9.npz	/home/shreya/scratch/Regional/regional_label/RL_20190321/_0019_tf2d18_retro_iPAT_FB_SA6/IM-0019-0009.npz	97.67714178381992,126.91924298485182,98.0,126.86736713677887,98.90842099109906,126.7214048940393,100.0,126.5460133940324,101.0,126.38533652265916,101.37097940565734,126.32572871241423,102.0,126.22465965128592,102.60225861293648,126.12789062160171,103.0,126.06398277991269,103.39820777792012,126.0,103.83353782021561,125.93005253078918,105.0,125.74262903716621,106.0,125.58195216579298,107.0,125.42127529441976,107.52737544205303,125.3365382583516,108.0,125.26059842304652,108.75865464933217,125.13870016753907,108.0,125.26059842304652,107.0,125.42127529441976,106.0,125.58195216579298,105.0,125.74262903716622,104.0,125.90330590853945,103.39820777792012,126.0,103.0,126.06398277991269,102.0,126.22465965128593,101.0,126.38533652265916,100.0,126.5460133940324,99.0,126.70669026540563,98.0,126.86736713677887,97.67714178381992,126.91924298485182,98.0,127.45602263510732,98.32718744383844,128.0,98.92865997735643,129.0,99.2105164650308,129.46861073776023,99.53013251087442,130.0,99.97720380563625,130.74329461421442,100.7330775779104,132.0,101.0,132.44378156476802,101.3345501114284,133.0,101.51057848684715,133.29266236712286,101.93602264494638,134.0,102.2772658274526,134.56734624357708,102.53749517846437,135.0,103.0,135.76895418454185,103.74044024550035,137.0,104.0,137.43154049442873,104.34191277901833,138.0,104.57732784926893,138.3913978729397,104.70081685143214,138.0,105.0,137.05174026903137,105.33183204441572,136.0,105.6473396409075,135.0,105.9628472373993,134.0,106.2783548338911,133.0,106.59386243038288,132.0,106.90937002687468,131.0,107.22487762336647,130.0,107.54038521985827,129.0,107.85589281635005,128.0,108.0,127.54325288756179,108.17140041284185,127.0,108.48690800933365,126.0,108.75865464933217,125.13870016753907,108.8085338620469,125.47769429549575,108.84551302840002,125.82199415192008,108.87126332969405,126.17004274008795,108.89629619203507,126.51856879696251,108.90930908113718,126.87030941654928,108.90456481054426,127.22897540069653,108.88864687800408,127.59024218781849,108.87397677063942,127.95465372711419,108.86664258733391,128.32585600282997,108.85283881470562,128.70129706228153,108.83698145657777,129.0819283670932,108.81001031190158,129.46099474258722,108.78241440340877,129.84362657770515,108.74970296606422,130.2300699555874,108.70381869077683,130.6095414736867,108.64406807679683,130.98732022799553,108.57673870457569,131.3663580852002,108.50450385250151,131.7410888338089,108.42879217132926,132.1127446397394,108.3457614709437,132.48389610260725,108.2565003672242,132.8512379437685,108.16355937838554,133.2087828269601,108.07480521261692,133.56937610134483,108.0,133.8775125964974,107.88225994199513,134.27207744903865,107.74790712505579,134.6025192046631,107.5792593741417,134.91762980995932,107.38990110546351,135.2187014986947,107.19427770376205,135.51257506027818,107.0,135.79824106212837,106.7860897025466,136.09066399767994,106.55881864786149,136.36344695061445,106.31508597731592,136.62423328951002,106.07432534635068,136.8847489948571,105.83736831635237,137.1473897598684,105.59587978214026,137.40520807862282,105.35112358301879,137.66012565553189,105.09463570028544,137.9049431782961,104.83564118385316,138.14746403723956,104.57732784926893,138.3913978729397 

examples = [['/home/shreya/scratch/Regional/polygon-transformer/results_polyformer_b/regional/epoch_100/vis/test_20240123192140/18279_4_inferolateral.png','inferolateral']]

io = gr.Interface(fn=visual_grounding, inputs=[gr.inputs.Image(type='pil'), "textbox"],
                  outputs=[gr.outputs.Image(label="output", type='numpy'), gr.outputs.Image(label="predicted mask", type='numpy')],
                  title=title, description=description, examples=examples,
                  allow_flagging=False, allow_screenshot=False, cache_examples=False)
io.launch(share=True)

